<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organization Dashboard - TransPenny</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; line-height: 1.6; background: #f4f4f4; }
        .navbar { background: #17a2b8; color: white; padding: 15px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .navbar h1 { display: inline-block; }
        .navbar-buttons { display: flex; gap: 10px; }
        .navbar button { padding: 10px 20px; background: #fff; color: #17a2b8; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .navbar button:hover { background: #f0f0f0; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        
        /* Welcome Section */
        .welcome-section { text-align: center; padding: 30px; background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; border-radius: 8px; margin-bottom: 30px; }
        .welcome-section h2 { margin-bottom: 10px; font-size: 2em; }
        .role-badge { display: inline-block; padding: 5px 15px; background: rgba(255,255,255,0.2); color: white; border-radius: 20px; font-size: 14px; margin-top: 10px; }
        .verification-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 14px; margin-left: 10px; }
        .verification-badge.approved { background: #28a745; color: white; }
        .verification-badge.pending { background: #ffc107; color: #333; }
        .verification-badge.rejected { background: #dc3545; color: white; }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        .stat-card h3 { font-size: 2em; color: #17a2b8; margin-bottom: 5px; }
        .stat-card p { color: #666; font-size: 14px; }
        .stat-card.highlight { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
        .stat-card.highlight h3, .stat-card.highlight p { color: white; }
        
        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s; background: white; color: #333; }
        .tab-btn:hover { background: #e9ecef; }
        .tab-btn.active { background: #17a2b8; color: white; }
        
        /* Tab Content */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Info Card */
        .info-card { background: white; padding: 25px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .info-card h3 { color: #333; margin-bottom: 15px; border-bottom: 2px solid #17a2b8; padding-bottom: 10px; }
        
        /* Tables */
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .data-table th { background: #f8f9fa; font-weight: 600; color: #333; }
        .data-table tr:hover { background: #f8f9fa; }
        .data-table .amount { color: #28a745; font-weight: bold; }
        
        /* Status Badges */
        .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .status-badge.pending { background: #fff3cd; color: #856404; }
        .status-badge.approved { background: #d4edda; color: #155724; }
        .status-badge.rejected { background: #f8d7da; color: #721c24; }
        .status-badge.completed { background: #cce5ff; color: #004085; }
        .status-badge.allocated { background: #cce5ff; color: #004085; }
        .status-badge.partially_spent { background: #fff3cd; color: #856404; }
        .status-badge.fully_spent { background: #d4edda; color: #155724; }
        
        /* Top Donors */
        .top-donors-list { list-style: none; }
        .top-donors-list li { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .top-donors-list li:last-child { border-bottom: none; }
        .donor-rank { width: 30px; height: 30px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; color: white; margin-right: 15px; }
        .rank-1 { background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%); }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0 0%, #a0a0a0 100%); }
        .rank-3 { background: linear-gradient(135deg, #cd7f32 0%, #a0522d 100%); }
        .rank-other { background: #17a2b8; }
        .donor-info { flex: 1; }
        .donor-name { font-weight: 600; }
        .donor-name.anonymous { font-style: italic; color: #888; }
        .donor-amount { color: #28a745; font-weight: bold; }
        
        /* Forms */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; transition: border-color 0.3s; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #17a2b8; }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        /* Buttons */
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s; }
        .btn-primary { background: #17a2b8; color: white; }
        .btn-primary:hover { background: #138496; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        /* Messages */
        .message { padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .message.info { background: #cce5ff; color: #004085; border: 1px solid #b8daff; }
        
        /* Impact Cards */
        .impact-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .impact-card { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); transition: transform 0.3s; }
        .impact-card:hover { transform: translateY(-5px); }
        .impact-card-header { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; padding: 15px; }
        .impact-card-header h4 { margin-bottom: 5px; }
        .impact-card-header .date { font-size: 12px; opacity: 0.9; }
        .impact-card-body { padding: 15px; }
        .impact-card-body p { color: #666; font-size: 14px; line-height: 1.6; margin-bottom: 10px; max-height: 80px; overflow: hidden; }
        .impact-card-footer { padding: 15px; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center; }
        .impact-amount { color: #28a745; font-weight: bold; }
        .impact-actions { display: flex; gap: 10px; }
        .impact-actions button { padding: 6px 12px; font-size: 12px; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; position: relative; }
        .modal-content h3 { margin-bottom: 20px; color: #333; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: #666; }
        .close-btn:hover { color: #333; }
        
        /* Loading */
        .loading { text-align: center; color: #17a2b8; padding: 30px; }
        .no-data { text-align: center; color: #666; padding: 30px; }
        
        /* Balance Display */
        .balance-display { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px; }
        .balance-display h4 { font-size: 14px; opacity: 0.9; margin-bottom: 5px; }
        .balance-display .amount { font-size: 2.5em; font-weight: bold; }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>üè¢ Organization Dashboard</h1>
        <div class="navbar-buttons">
            <button onclick="window.location.href='dashboard.html'">‚Üê Back to Profile</button>
            <button onclick="logout()">Logout</button>
        </div>
    </div>
    
    <div class="container">
        <!-- Welcome Section -->
        <div class="welcome-section">
            <h2 id="orgName">Organization Dashboard</h2>
            <p id="orgDescription"></p>
            <span class="role-badge">ORGANIZATION</span>
            <span id="verificationBadge" class="verification-badge"></span>
        </div>
        
        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3 id="statTotalRaised">$0.00</h3>
                <p>Total Raised</p>
            </div>
            <div class="stat-card highlight">
                <h3 id="statAvailableBalance">$0.00</h3>
                <p>Available Balance</p>
            </div>
            <div class="stat-card">
                <h3 id="statTotalDonations">0</h3>
                <p>Total Donations</p>
            </div>
            <div class="stat-card">
                <h3 id="statImpactStories">0</h3>
                <p>Impact Stories</p>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('overview')">üìä Overview</button>
            <button class="tab-btn" onclick="showTab('withdrawals')">üí≥ Withdrawals</button>
            <button class="tab-btn" onclick="showTab('impacts')">‚≠ê Impact Stories</button>
            <button class="tab-btn" onclick="showTab('donations')">üí∞ Donations</button>
        </div>
        
        <!-- Overview Tab -->
        <div id="overviewTab" class="tab-content active">
            <div class="info-card">
                <h3>üèÜ Top 5 Donors</h3>
                <div id="topDonorsContent">
                    <p class="loading">Loading top donors...</p>
                </div>
            </div>
            
            <div class="info-card">
                <h3>üìù Organization Description</h3>
                <p id="orgDescriptionFull" style="color: #666; line-height: 1.8;"></p>
            </div>
        </div>
        
        <!-- Withdrawals Tab -->
        <div id="withdrawalsTab" class="tab-content">
            <div class="info-card">
                <h3>üí≥ Make Withdrawal</h3>
                <div id="withdrawalMessage"></div>
                
                <div class="balance-display">
                    <h4>Available Balance</h4>
                    <div class="amount" id="withdrawAvailableBalance">$0.00</div>
                </div>
                
                <form id="withdrawalForm" onsubmit="submitWithdrawal(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="withdrawAmount">Amount ($) *</label>
                            <input type="number" id="withdrawAmount" min="1" step="0.01" required placeholder="Enter amount to withdraw">
                        </div>
                        <div class="form-group">
                            <label for="bankAccount">Bank Account Number *</label>
                            <input type="text" id="bankAccount" required placeholder="Enter bank account number">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="withdrawPurpose">Purpose / Description *</label>
                        <textarea id="withdrawPurpose" required placeholder="Describe the purpose of this withdrawal..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="withdrawImpactStory">Link to Impact Story (Optional)</label>
                        <select id="withdrawImpactStory">
                            <option value="">-- Select an Impact Story --</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            Linking a withdrawal to an impact story helps donors see how their contributions are being used.
                        </small>
                    </div>
                    <button type="submit" class="btn btn-success" id="withdrawBtn">Make Withdrawal</button>
                </form>
            </div>
            
            <div class="info-card">
                <h3>üìã Withdrawal History</h3>
                <div id="withdrawalHistoryContent">
                    <p class="loading">Loading withdrawal history...</p>
                </div>
            </div>
        </div>
        
        <!-- Impact Stories Tab -->
        <div id="impactsTab" class="tab-content">
            <div class="info-card">
                <h3>‚ûï Create Impact Story</h3>
                <div id="impactMessage"></div>
                
                <form id="impactForm" onsubmit="submitImpact(event)">
                    <div class="form-group">
                        <label for="impactTitle">Title *</label>
                        <input type="text" id="impactTitle" required placeholder="Enter impact story title">
                    </div>
                    <div class="form-group">
                        <label for="impactContent">Description *</label>
                        <textarea id="impactContent" required placeholder="Describe the impact of donations..."></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="impactAmount">Amount Used ($)</label>
                            <input type="number" id="impactAmount" min="0" step="0.01" placeholder="Amount spent for this impact">
                        </div>
                        <div class="form-group">
                            <label for="impactGeoTag">Location</label>
                            <input type="text" id="impactGeoTag" placeholder="e.g., Nairobi, Kenya">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="impactMediaUrl">Media URL (Optional)</label>
                            <input type="url" id="impactMediaUrl" placeholder="https://example.com/image.jpg">
                        </div>
                        <div class="form-group">
                            <label for="impactMediaType">Media Type</label>
                            <select id="impactMediaType">
                                <option value="image">Image</option>
                                <option value="video">Video</option>
                                <option value="document">Document</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="impactPublish" checked> Publish immediately
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary" id="impactBtn">Create Impact Story</button>
                </form>
            </div>
            
            <div class="info-card">
                <h3>üìö Your Impact Stories</h3>
                <div id="impactStoriesContent">
                    <p class="loading">Loading impact stories...</p>
                </div>
            </div>
        </div>
        
        <!-- Donations Tab -->
        <div id="donationsTab" class="tab-content">
            <div class="info-card">
                <h3>üí∞ Received Donations</h3>
                <div id="donationsContent">
                    <p class="loading">Loading donations...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeDeleteModal()">&times;</span>
            <h3>‚ö†Ô∏è Confirm Delete</h3>
            <p style="margin-bottom: 20px; color: #666;">Are you sure you want to delete this impact story? This action cannot be undone.</p>
            <p style="margin-bottom: 20px;"><strong id="deleteImpactTitle"></strong></p>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDeleteImpact()">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // Check if user is logged in and is an organization
        const userStr = sessionStorage.getItem('user');
        if (!userStr) {
            window.location.href = 'login.html';
        }
        
        const user = JSON.parse(userStr);
        
        if (user.userType !== 'organization' || !user.orgInfo) {
            alert('Access denied. This dashboard is for organizations only.');
            window.location.href = 'dashboard.html';
        }
        
        const organizationId = user.orgInfo.organizationId;
        let currentImpactToDelete = null;
        let orgOverviewData = null;
        let isSubmittingWithdrawal = false;
        let isSubmittingImpact = false;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadOrganizationOverview();
        });
        
        function logout() {
            sessionStorage.removeItem('user');
            window.location.href = 'index.html';
        }
        
        // Tab Navigation
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            // Load data for specific tabs
            if (tabName === 'withdrawals') {
                loadWithdrawalHistory();
                loadImpactStoriesForWithdrawal(); // Load impact stories for dropdown
            } else if (tabName === 'impacts') {
                loadImpactStories();
            } else if (tabName === 'donations') {
                loadDonations();
            }
        }
        
        // Load Organization Overview
        async function loadOrganizationOverview() {
            try {
                const response = await fetch(`api/GetOrganizationOverview.php?organizationId=${organizationId}`);
                const result = await response.json();
                
                if (result.success) {
                    orgOverviewData = result.data;
                    updateDashboardUI(result.data);
                } else {
                    console.error('Failed to load overview:', result.message);
                }
            } catch (error) {
                console.error('Error loading overview:', error);
            }
        }
        
        function updateDashboardUI(data) {
            // Update welcome section
            document.getElementById('orgName').textContent = data.name || 'Organization Dashboard';
            document.getElementById('orgDescription').textContent = data.description ? data.description.substring(0, 100) + '...' : '';
            document.getElementById('orgDescriptionFull').textContent = data.description || 'No description provided.';
            
            // Update verification badge
            const badge = document.getElementById('verificationBadge');
            badge.textContent = data.verificationStatus ? data.verificationStatus.toUpperCase() : 'PENDING';
            badge.className = 'verification-badge ' + (data.verificationStatus || 'pending');
            
            // Update stats
            document.getElementById('statTotalRaised').textContent = '$' + parseFloat(data.totalReceived || 0).toFixed(2);
            document.getElementById('statAvailableBalance').textContent = '$' + parseFloat(data.availableBalance || 0).toFixed(2);
            document.getElementById('statTotalDonations').textContent = data.donationCount || 0;
            document.getElementById('statImpactStories').textContent = data.impactCount || 0;
            
            // Update withdrawal balance display
            document.getElementById('withdrawAvailableBalance').textContent = '$' + parseFloat(data.availableBalance || 0).toFixed(2);
            
            // Update top donors
            updateTopDonors(data.topDonors || []);
        }
        
        function updateTopDonors(donors) {
            const container = document.getElementById('topDonorsContent');
            
            if (donors.length === 0) {
                container.innerHTML = '<p class="no-data">No donations received yet. Share your organization to start receiving donations!</p>';
                return;
            }
            
            container.innerHTML = `
                <ul class="top-donors-list">
                    ${donors.map((donor, index) => `
                        <li>
                            <span class="donor-rank ${index < 3 ? 'rank-' + (index + 1) : 'rank-other'}">${index + 1}</span>
                            <div class="donor-info">
                                <span class="donor-name ${donor.isAnonymous ? 'anonymous' : ''}">${donor.displayName}</span>
                                <br><small style="color: #888;">${donor.donationCount} donation${donor.donationCount > 1 ? 's' : ''}</small>
                            </div>
                            <span class="donor-amount">$${parseFloat(donor.totalAmount).toFixed(2)}</span>
                        </li>
                    `).join('')}
                </ul>
            `;
        }
        
        // Load Withdrawal History
        async function loadWithdrawalHistory() {
            const container = document.getElementById('withdrawalHistoryContent');
            container.innerHTML = '<p class="loading">Loading withdrawal history...</p>';
            
            try {
                const response = await fetch(`api/GetWithdrawals.php?organizationId=${organizationId}`);
                const result = await response.json();
                
                if (result.success) {
                    if (result.data.length === 0) {
                        container.innerHTML = '<p class="no-data">No withdrawal requests yet.</p>';
                        return;
                    }
                    
                    container.innerHTML = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Purpose</th>
                                    <th>Bank Account</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${result.data.map(w => `
                                    <tr>
                                        <td>${new Date(w.requestedAt).toLocaleDateString()}</td>
                                        <td class="amount">$${parseFloat(w.amount).toFixed(2)}</td>
                                        <td>${w.purpose.substring(0, 50)}${w.purpose.length > 50 ? '...' : ''}</td>
                                        <td>${w.bankAccountNumber || 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = '<p class="no-data">Failed to load withdrawal history.</p>';
                }
            } catch (error) {
                container.innerHTML = '<p class="no-data">Failed to load withdrawal history.</p>';
            }
        }
        
        // Load Impact Stories for Withdrawal Dropdown
        async function loadImpactStoriesForWithdrawal() {
            const select = document.getElementById('withdrawImpactStory');
            select.innerHTML = '<option value="">-- Loading Impact Stories... --</option>';
            
            try {
                const response = await fetch(`api/GetOrgImpacts.php?organizationId=${organizationId}`);
                const result = await response.json();
                
                if (result.success) {
                    let options = '<option value="">-- Select an Impact Story (Optional) --</option>';
                    
                    if (result.data.length > 0) {
                        result.data.forEach(story => {
                            const truncatedTitle = story.title.length > 50 ? story.title.substring(0, 50) + '...' : story.title;
                            const statusIcon = story.isPublished ? '‚úÖ' : 'üìù';
                            options += `<option value="${story.storyId}">${statusIcon} ${truncatedTitle}</option>`;
                        });
                    }
                    
                    select.innerHTML = options;
                } else {
                    select.innerHTML = '<option value="">-- No Impact Stories Available --</option>';
                }
            } catch (error) {
                select.innerHTML = '<option value="">-- Failed to Load Impact Stories --</option>';
            }
        }
        
        // Submit Withdrawal Request
        async function submitWithdrawal(event) {
            event.preventDefault();
            
            if (isSubmittingWithdrawal) return;
            isSubmittingWithdrawal = true;
            
            const btn = document.getElementById('withdrawBtn');
            const messageDiv = document.getElementById('withdrawalMessage');
            
            btn.disabled = true;
            btn.textContent = 'Processing...';
            messageDiv.innerHTML = '';
            
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const bankAccount = document.getElementById('bankAccount').value.trim();
            const purpose = document.getElementById('withdrawPurpose').value.trim();
            const impactStoryId = document.getElementById('withdrawImpactStory').value || null;
            const availableBalance = parseFloat(orgOverviewData?.availableBalance || 0);
            
            // Validate amount
            if (amount <= 0) {
                messageDiv.innerHTML = '<div class="message error">Please enter a valid amount.</div>';
                btn.disabled = false;
                btn.textContent = 'Request Withdrawal';
                isSubmittingWithdrawal = false;
                return;
            }
            
            if (amount > availableBalance) {
                messageDiv.innerHTML = '<div class="message error">Insufficient balance. Available: $' + availableBalance.toFixed(2) + '</div>';
                btn.disabled = false;
                btn.textContent = 'Request Withdrawal';
                isSubmittingWithdrawal = false;
                return;
            }
            
            try {
                const response = await fetch('api/CreateWithdrawal.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        organizationId: organizationId,
                        amount: amount,
                        bankAccountNumber: bankAccount,
                        purpose: purpose,
                        impactStoryId: impactStoryId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    messageDiv.innerHTML = '<div class="message success">Withdrawal request submitted successfully! Status: Pending</div>';
                    document.getElementById('withdrawalForm').reset();
                    document.getElementById('withdrawImpactStory').value = '';
                    
                    // Refresh data
                    loadOrganizationOverview();
                    loadWithdrawalHistory();
                    loadImpactStoriesForWithdrawal();
                } else {
                    messageDiv.innerHTML = `<div class="message error">${result.message}</div>`;
                }
            } catch (error) {
                messageDiv.innerHTML = '<div class="message error">Failed to submit withdrawal request. Please try again.</div>';
            }
            
            btn.disabled = false;
            btn.textContent = 'Request Withdrawal';
            isSubmittingWithdrawal = false;
        }
        
        // Load Impact Stories
        async function loadImpactStories() {
            const container = document.getElementById('impactStoriesContent');
            container.innerHTML = '<p class="loading">Loading impact stories...</p>';
            
            try {
                const response = await fetch(`api/GetOrgImpacts.php?organizationId=${organizationId}`);
                const result = await response.json();
                
                if (result.success) {
                    if (result.data.length === 0) {
                        container.innerHTML = '<p class="no-data">No impact stories yet. Create your first impact story above!</p>';
                        return;
                    }
                    
                    container.innerHTML = `
                        <div class="impact-grid">
                            ${result.data.map(impact => `
                                <div class="impact-card">
                                    <div class="impact-card-header">
                                        <h4>${impact.title}</h4>
                                        <span class="date">üìÖ ${new Date(impact.publishedAt).toLocaleDateString()}</span>
                                    </div>
                                    <div class="impact-card-body">
                                        <p>${impact.content}</p>
                                        ${impact.geoTag ? `<small style="color: #888;">üìç ${impact.geoTag}</small>` : ''}
                                    </div>
                                    <div class="impact-card-footer">
                                        <span class="impact-amount">$${parseFloat(impact.totalFunding || 0).toFixed(2)}</span>
                                        <div class="impact-actions">
                                            <span class="status-badge ${impact.isPublished ? 'approved' : 'pending'}">${impact.isPublished ? 'Published' : 'Draft'}</span>
                                            <button class="btn btn-danger" onclick="openDeleteModal('${impact.storyId}', '${impact.title.replace(/'/g, "\\'")}')">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = '<p class="no-data">Failed to load impact stories.</p>';
                }
            } catch (error) {
                container.innerHTML = '<p class="no-data">Failed to load impact stories.</p>';
            }
        }
        
        // Submit Impact Story
        async function submitImpact(event) {
            event.preventDefault();
            
            if (isSubmittingImpact) return;
            isSubmittingImpact = true;
            
            const btn = document.getElementById('impactBtn');
            const messageDiv = document.getElementById('impactMessage');
            
            btn.disabled = true;
            btn.textContent = 'Creating...';
            messageDiv.innerHTML = '';
            
            const title = document.getElementById('impactTitle').value.trim();
            const content = document.getElementById('impactContent').value.trim();
            const amount = parseFloat(document.getElementById('impactAmount').value) || 0;
            const geoTag = document.getElementById('impactGeoTag').value.trim();
            const mediaUrl = document.getElementById('impactMediaUrl').value.trim();
            const mediaType = document.getElementById('impactMediaType').value;
            const isPublished = document.getElementById('impactPublish').checked;
            
            try {
                const response = await fetch('api/CreateImpact.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        organizationId: organizationId,
                        title: title,
                        content: content,
                        totalFunding: amount,
                        geoTag: geoTag || null,
                        mediaUrl: mediaUrl || null,
                        mediaType: mediaType,
                        isPublished: isPublished
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    messageDiv.innerHTML = '<div class="message success">Impact story created successfully!</div>';
                    document.getElementById('impactForm').reset();
                    document.getElementById('impactPublish').checked = true;
                    
                    // Refresh data
                    loadOrganizationOverview();
                    loadImpactStories();
                } else {
                    messageDiv.innerHTML = `<div class="message error">${result.message}</div>`;
                }
            } catch (error) {
                messageDiv.innerHTML = '<div class="message error">Failed to create impact story. Please try again.</div>';
            }
            
            btn.disabled = false;
            btn.textContent = 'Create Impact Story';
            isSubmittingImpact = false;
        }
        
        // Delete Impact Functions
        function openDeleteModal(storyId, title) {
            currentImpactToDelete = storyId;
            document.getElementById('deleteImpactTitle').textContent = title;
            document.getElementById('deleteModal').classList.add('active');
        }
        
        function closeDeleteModal() {
            currentImpactToDelete = null;
            document.getElementById('deleteModal').classList.remove('active');
        }
        
        async function confirmDeleteImpact() {
            if (!currentImpactToDelete) return;
            
            const btn = document.getElementById('confirmDeleteBtn');
            btn.disabled = true;
            btn.textContent = 'Deleting...';
            
            try {
                const response = await fetch('api/DeleteImpact.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        storyId: currentImpactToDelete,
                        organizationId: organizationId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeDeleteModal();
                    loadOrganizationOverview();
                    loadImpactStories();
                } else {
                    alert(result.message || 'Failed to delete impact story.');
                }
            } catch (error) {
                alert('Failed to delete impact story. Please try again.');
            }
            
            btn.disabled = false;
            btn.textContent = 'Delete';
        }
        
        // Load Donations
        async function loadDonations() {
            const container = document.getElementById('donationsContent');
            container.innerHTML = '<p class="loading">Loading donations...</p>';
            
            try {
                const response = await fetch(`api/GetOrgDonations.php?organizationId=${organizationId}`);
                const result = await response.json();
                
                if (result.success) {
                    if (result.data.length === 0) {
                        container.innerHTML = '<p class="no-data">No donations received yet. Share your organization to start receiving donations!</p>';
                        return;
                    }
                    
                    container.innerHTML = `
                        <p style="margin-bottom: 15px; color: #666;">
                            <strong>Total Donations:</strong> ${result.count} | 
                            <strong>Total Received:</strong> $${result.totalReceived.toFixed(2)} |
                            <strong>Available Balance:</strong> $${result.availableBalance.toFixed(2)}
                        </p>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Donor</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Payment Method</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${result.data.map(d => `
                                    <tr>
                                        <td>${new Date(d.donatedAt).toLocaleDateString()}</td>
                                        <td>${d.donorName}</td>
                                        <td class="amount">$${parseFloat(d.amountTotal).toFixed(2)}</td>
                                        <td><span class="status-badge ${d.status}">${d.status.replace('_', ' ')}</span></td>
                                        <td>${d.paymentMethod}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = '<p class="no-data">Failed to load donations.</p>';
                }
            } catch (error) {
                container.innerHTML = '<p class="no-data">Failed to load donations.</p>';
            }
        }
    </script>
</body>
</html>
